---
- name: Create temp directory
  ansible.builtin.tempfile:
    state: directory
    suffix: -toolforge-lima-kilo
  register: tempdir

- name: Git clone custom k8s components
  ansible.builtin.command:
    cmd: git clone --quiet {{ item.git_url }} {{ tempdir.path }}/{{ item.name }}
    creates: "{{ tempdir.path }}/{{ item.name }}/.git"
  loop: "{{ k8s_custom_components }}"
  loop_control:
    label: "{{ item.name }}"

- name: Build docker image
  ansible.builtin.shell: # noqa no-changed-when
    chdir: "{{ tempdir.path }}/{{ item.name }}"
    cmd: docker build --tag {{ item.name }}:latest .
  loop: "{{ k8s_custom_components }}"
  loop_control:
    label: "{{ item.name }}"

- name: Load docker image into kind (if using kind)
  ansible.builtin.shell:
    cmd: kind load docker-image {{ item.name }}:latest --name {{ kind.cluster.name }}
  loop: "{{ k8s_custom_components }}"
  loop_control:
    label: "{{ item.name }}"
  when: kind is defined

- name: Deploy custom component into k8s
  ansible.builtin.shell: # noqa no-changed-when
    chdir: "{{ tempdir.path }}/{{ item.name }}"
    cmd: "{{ item.deploy }}"
  loop: "{{ k8s_custom_components }}"
  loop_control:
    label: "{{ item.name }}"

- name: Remove the temp dir
  ansible.builtin.file:
    path: "{{ tempdir.path }}"
    state: absent
  when: tempdir.path is defined
  diff: false
